rule MALWARE_PlugX_USB_Delivery_LNK_Jun23
{
    meta:
        author = "SECUINFRA Falcon Team (@SI_FalconTeam)"
        description = "Detects PlugX-style Malware delivery via removable Drives (USB) - LNK File"
        reference = "https://unit42.paloaltonetworks.com/plugx-variants-in-usbs/"
        date = "2023-06-21"
        tlp = "CLEAR"

    strings:

        /*
        These rules are based on the Proof-of-Concept which was presented at 
        REcon 2023 in Montreal, Canada by Michael Harbison (Palo Alto Networks Unit42)
        */

        $lnk_magic = {4C 00 00 00 01 14 02 00}

        $driveletter_4X = {4? 00 3A 00 5C 00 A0 00 5C}
        $driveletter_5X = {5? 00 3A 00 5C 00 A0 00 5C}

        $s_cmd = "C:\\Windows\\System32\\cmd.exe" ascii
        $s_recBin = "\\RECYCLER.BIN\\" wide
        $s_shell32 = "%SystemRoot%\\system32\\SHELL32.dll" wide
        $s_comspec = "%ComSpec%" ascii

    condition:
        $lnk_magic at 0x0
        and any of ($s_*)
        and ($driveletter_4X or $driveletter_5X)
}

rule MALWARE_PlugX_USB_Delivery_ini_Icon_Jun23
{
    meta:
        author = "SECUINFRA Falcon Team (@SI_FalconTeam)"
        description = "Detects PlugX-style Malware delivery via removable Drives (USB) - Desktop.ini Icon File; could potentially yield FPs"
        reference = "https://unit42.paloaltonetworks.com/plugx-variants-in-usbs/"
        date = "2023-06-21"
        tlp = "CLEAR"

    strings:
        $s_shellclassinfo = "[.ShellClassInfo]" ascii
        // Drive Icon
        $s_IconRes = "IconResource=C:\\Windows\\system32\\SHELL32.dll,7" ascii

    condition:
        all of ($s_*)
}

rule MALWARE_PlugX_USB_Delivery_ini_RecBin_Jun23
{
    meta:
        author = "SECUINFRA Falcon Team (@SI_FalconTeam)"
        description = "Detects PlugX-style Malware delivery via removable Drives (USB) - Desktop.ini Recycle Bin; could potentially yield FPs"
        reference = "https://unit42.paloaltonetworks.com/plugx-variants-in-usbs/"
        date = "2023-06-21"
        tlp = "CLEAR"

    strings:
        $s_shellclassinfo = "[.ShellClassInfo]" ascii
        // Recycle Bin CLSID
        $s_IconRes = "CLSID = {645FF040-5081-101B-9F08-00AA002F954E}" ascii

        $neg_LRN = "shell32.dll,-8964" ascii

    condition:
        all of ($s_*)
        and not $neg_LRN
}
